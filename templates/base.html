{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}متجر الهدايا{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }

        /* Notification Dropdown Styles */
        .notification-dropdown {
            width: 380px;
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #f0f0f0;
        }

        .notification-header, .notification-footer {
            padding: 1rem;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .notification-header h6 {
            margin: 0;
            font-weight: 600;
        }

        .notification-body {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 0.75rem 1rem;
            transition: background-color 0.2s ease;
        }

        .notification-item.notification-unread {
            background-color: #f0f2f5;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: #fef8f2;
        }
        .notification-item.unread:hover {
            background-color: #fdeedc;
        }
        
        .notification-item .icon-wrapper {
            flex-shrink: 0;
            margin-left: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #A67B5B20; /* Primary color with low opacity */
            color: var(--primary-color, #A67B5B);
        }

        .notification-item .icon-wrapper i {
            font-size: 1.2rem;
        }

        .notification-item .content-wrapper {
            flex-grow: 1;
        }

        .notification-item .content-wrapper .title {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .notification-item .content-wrapper .message {
            color: #6c757d;
            font-size: 0.85rem;
            line-height: 1.4;
            margin: 0;
        }
        
        .notification-item .content-wrapper .timestamp {
            font-size: 0.75rem;
            color: #adb5bd;
            margin-top: 0.5rem;
        }

        .notification-empty {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .notification-footer {
            background-color: #f8f9fa;
            text-align: center;
        }

        .notification-handle-container {
            display: none; /* Hidden by default on desktop */
        }

        /* Mobile specific styles for notifications */
        @media (max-width: 767.98px) {
            .notification-dropdown.show {
                position: fixed !important;
                top: auto !important; /* Anchor to the bottom */
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100vw !important;
                height: 85vh !important; /* Smaller height */
                max-height: 85vh !important;
                background: white !important;
                opacity: 1 !important;
                z-index: 9999 !important;
                border: none !important;
                border-top-left-radius: 20px !important; /* Rounded corners */
                border-top-right-radius: 20px !important;
                display: flex !important;
                flex-direction: column !important;
                animation: slideInUp 0.3s ease-out;
                overflow: hidden; /* Ensure children respect rounded corners */
                transform: translate3d(0,0,0) !important; /* Better performance animation */
            }

            .notification-handle-container {
                display: block;
                padding: 0.75rem 0;
                text-align: center;
                border-bottom: 1px solid #e9ecef;
            }

            .notification-handle {
                display: inline-block;
                width: 40px;
                height: 5px;
                background-color: #dcdcdc;
                border-radius: 2.5px;
            }

            .notification-dropdown .notification-body {
                flex-grow: 1;
                height: auto;
                max-height: none;
                overflow-y: auto;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --font-main: 'Cairo', sans-serif;
            --color-primary: #A67B5B; /* Warm Tan */
            --color-secondary: #6c757d; /* Bootstrap Secondary */
            --color-surface: #ffffff;
            --color-bg: #f8f9fa;     /* Bootstrap Light Gray */
            --color-text: #212529;    /* Bootstrap Dark */
            --color-border: #dee2e6;  /* Bootstrap Border Color */
            --header-height: 70px;
            --bottom-nav-height: 70px;
            --border-radius: 0.375rem; /* Bootstrap Default */
            --transition-speed: 0.3s;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            padding-top: var(--header-height); /* For fixed top navbar */
            padding-bottom: 70px; /* For fixed bottom navbar on mobile */
            line-height: 1.6;
            text-align: right;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main.main-content {
            flex-grow: 1; /* Ensures footer sticks to the bottom */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        a {
            transition: color var(--transition-speed) ease;
        }

        /* --- Header & Navigation --- */

        /* Top Navbar - Desktop & Mobile */
        #main-navbar {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-border);
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        #main-navbar.scrolled {
            background-color: var(--color-surface);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
        }

        .navbar-brand .logo-img {
            max-height: 40px;
        }

        .navbar-brand .logo-text {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--color-text);
        }

        .nav-icon {
            font-size: 1.5rem;
            color: var(--color-text);
            position: relative;
        }

        .nav-icon .cart-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            font-size: 0.65rem;
            font-weight: bold;
            border-radius: 50%;
            padding: 0.2em 0.5em;
        }

        /* Hides the default Bootstrap toggler icon */
        .navbar-toggler {
            border: none;
            font-size: 1.5rem;
        }
        .navbar-toggler:focus {
            box-shadow: none;
        }

        /* Off-canvas Menu */
        .offcanvas {
            background-color: var(--color-bg);
        }
        .offcanvas-title {
            font-weight: 600;
        }

        /* Bottom Mobile Navigation */
        .bottom-nav {
            display: none; /* Hidden by default, shown on mobile */
        }

        /* --- Main Content --- */
        .product-card {
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            background-color: var(--color-surface);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .product-card-img-container {
            aspect-ratio: 1 / 1; /* Enforce square shape */
            overflow: hidden;
            position: relative;
        }

        .product-card .card-img-top {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Crop image to fit container */
            transition: transform var(--transition-speed) ease;
        }

        .product-card:hover .card-img-top {
            transform: scale(1.05);
        }

        .product-card-actions-overlay {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem; /* Adjusted for RTL */
            z-index: 2; /* Ensure buttons are on top of the overlay */
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            opacity: 0;
            transform: translateX(10px);
            pointer-events: none; /* Disable clicks when hidden */
            transition: opacity var(--transition-speed), transform var(--transition-speed);
        }

        .product-card:hover .product-card-actions-overlay {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto; /* Enable clicks when visible */
        }

        .product-card-actions-overlay .btn {
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .product-card .card-footer {
            background-color: transparent;
        }

        .product-card-img-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity var(--transition-speed) ease;
            z-index: 1;
        }

        .product-card:hover .product-card-img-container::after {
            opacity: 1;
        }

        .product-card .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .product-card .card-text {
            color: var(--color-primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* --- Footer --- */
        .main-footer {
            background-color: var(--color-surface);
            color: var(--color-text);
            padding: 3rem 0;
            border-top: 1px solid var(--color-border);
        }

        .main-footer h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .main-footer .list-unstyled a {
            color: var(--color-secondary);
            text-decoration: none;
        }
        .main-footer .list-unstyled a:hover {
            color: var(--color-primary);
        }

        .main-footer .copyright {
            color: var(--color-secondary);
            font-size: 0.9rem;
        }

        /* --- Homepage Specific Styles --- */
        .hero-section {
            position: relative;
            height: 60vh;
            min-height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
        }
        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }
        .hero-background::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .category-showcase-card {
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius);
        }
        .category-showcase-card img {
            transition: transform var(--transition-speed) ease;
        }
        .category-showcase-card:hover img {
            transform: scale(1.05);
        }
        .category-card-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }
        
        .value-prop-item .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* --- Responsive Design --- */

        /* Medium devices (tablets, less than 992px) */
        @media (max-width: 991.98px) {
            body {
                padding-bottom: var(--bottom-nav-height); /* Only apply padding for bottom nav on mobile */
            }
            
            /* Hide desktop nav links and show mobile toggler */
            #desktop-nav-links {
                display: none;
            }

            /* Show and style mobile bottom nav */
            .bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: var(--bottom-nav-height);
                background-color: var(--color-surface);
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                z-index: 1030;
                border-top: 1px solid var(--color-border);
                justify-content: space-around;
                align-items: center;
            }

            .bottom-nav-item {
                flex: 1;
                text-align: center;
                padding: 10px 0;
                color: var(--color-secondary);
                text-decoration: none;
                transition: color 0.2s;
            }
            .bottom-nav-item i {
                font-size: 1.3rem;
                display: block;
                margin-bottom: 4px;
            }
            .bottom-nav-item span {
                font-size: 0.7rem;
                font-weight: 500;
            }
            .bottom-nav-item.active,
            .bottom-nav-item:hover {
                color: var(--color-primary);
            }
            
            /* Center the logo on mobile top bar */
            .navbar-brand {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
            }

            /* Ensure toggler is on the left and icons are on the right */
            .navbar .container-fluid {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }
            .navbar-toggler {
                order: -1; /* Puts it on the far left */
            }
        }

        /* Small devices (landscape phones, less than 768px) */
        @media (max-width: 767.98px) {
            .product-card .card-img-top {
                height: 220px;
            }
        }

        /* Extra small devices (portrait phones, less than 576px) */
        @media (max-width: 575.98px) {
            /* Make product cards take two columns */
            .product-card-container {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body data-user="{{ user.is_authenticated|yesno:'true,false' }}">

    <!-- Top Navbar -->
    {% block navbar %}
    <nav class="navbar navbar-expand-lg fixed-top" id="main-navbar">
        <div class="container-fluid">
            <!-- Hamburger Menu (Mobile) -->
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Logo -->
            <a class="navbar-brand" href="{% url 'store:home' %}">
                {% if site_config.logo %}
                    <img src="{{ site_config.logo.url }}" alt="Logo" class="logo-img">
                {% else %}
                    <span class="logo-text">{% if site_config %}{{ site_config.site_name }}{% else %}متجري{% endif %}</span>
                {% endif %}
            </a>

            <!-- Desktop Links -->
            <div class="collapse navbar-collapse" id="desktop-nav-links">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="{% url 'store:home' %}">{% trans "الرئيسية" %}</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'store:store' %}">{% trans "المتجر" %}</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'store:about' %}">{% trans "من نحن" %}</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'store:contact' %}">{% trans "تواصل معنا" %}</a></li>
                </ul>
            </div>

            <!-- Icons and User Dropdown -->
            <div class="d-flex align-items-center">
                <a href="{% url 'store:wishlist' %}" class="nav-icon me-3"><i class="fas fa-heart"></i></a>
                
                <div class="dropdown">
                    <a href="#" class="nav-icon me-3" id="notificationBell" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        {% if unread_notifications_count > 0 %}
                           <span class="badge bg-danger cart-badge">{{ unread_notifications_count }}</span>
                        {% endif %}
                    </a>
                    <div class="dropdown-menu dropdown-menu-start notification-dropdown" aria-labelledby="notificationBell">
                        <div class="notification-handle-container">
                            <div class="notification-handle"></div>
                        </div>
                        <div class="notification-header">
                            <h6 class="mb-0">{% trans "الإشعارات" %}</h6>
                            {% if unread_notifications_count > 0 %}
                                <a href="#" class="text-muted small">{% trans "تحديد الكل كمقروء" %}</a>
                            {% endif %}
                        </div>
                        <div class="notification-body">
                            {% for notification in notifications %}
                            <a href="#" class="dropdown-item notification-item {% if not notification.read %}notification-unread{% endif %}">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="notification-icon">
                                            <i class="fas fa-info-circle"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="notification-title mb-1">{{ notification.title }}</h6>
                                        <p class="notification-message mb-1 small">{{ notification.message|truncatechars:80 }}</p>
                                        <small class="text-muted">{{ notification.created_at|timesince }} {% trans "منذ" %}</small>
                                    </div>
                                </div>
                            </a>
                            {% empty %}
                            <div class="text-center p-3">
                                <p class="mb-0">{% trans "لا توجد إشعارات جديدة" %}</p>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="notification-footer">
                             <a href="#" class="btn btn-primary btn-sm w-100">{% trans "عرض كل الإشعارات" %}</a>
                        </div>
                    </div>
                </div>

                <a href="{% url 'store:cart' %}" class="nav-icon me-3">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="badge bg-danger cart-badge">{{ cart_items_count|default:0 }}</span>
                </a>

                {% if user.is_authenticated %}
                <div class="dropdown">
                    <a href="#" class="nav-icon me-3" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user-circle"></i></a>
                    <ul class="dropdown-menu dropdown-menu-start">
                        <li><a class="dropdown-item" href="{% url 'store:account' %}">{% trans "حسابي" %}</a></li>
                        {% if user.is_staff %}
                        <li><a class="dropdown-item" href="{% url 'admin:index' %}">{% trans "لوحة التحكم" %}</a></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="{% url 'store:logout' %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">{% trans "تسجيل الخروج" %}</button>
                            </form>
                        </li>
                    </ul>
                </div>
                {% else %}
                <a href="{% url 'store:login' %}" class="btn btn-outline-primary btn-sm me-2">{% trans "دخول" %}</a>
                <a href="{% url 'store:register' %}" class="btn btn-primary btn-sm">{% trans "تسجيل" %}</a>
                {% endif %}
            </div>
        </div>
    </nav>
    {% endblock navbar %}

    <!-- Off-canvas Mobile Menu -->
    {% block offcanvas_menu %}
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">{% trans "القائمة" %}</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                <li class="nav-item"><a class="nav-link" href="{% url 'store:home' %}">{% trans "الرئيسية" %}</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'store:store' %}">{% trans "المتجر" %}</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'store:about' %}">{% trans "من نحن" %}</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'store:contact' %}">{% trans "تواصل معنا" %}</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'store:wishlist' %}">{% trans "المفضلة" %}</a></li>
            </ul>
        </div>
    </div>
    {% endblock offcanvas_menu %}

    <!-- Bottom Mobile Navigation -->
    {% block bottom_nav %}
    <nav class="bottom-nav">
        <a href="{% url 'store:home' %}" class="bottom-nav-item active">
            <i class="fas fa-home"></i>
            <span>{% trans "الرئيسية" %}</span>
        </a>
        <a href="{% url 'store:store' %}" class="bottom-nav-item">
            <i class="fas fa-store"></i>
            <span>{% trans "المتجر" %}</span>
        </a>
        <a href="{% url 'store:cart' %}" class="bottom-nav-item">
            <i class="fas fa-shopping-cart"></i>
            <span>{% trans "السلة" %}</span>
        </a>
        <a href="{% url 'store:account' %}" class="bottom-nav-item">
            <i class="fas fa-user"></i>
            <span>{% trans "حسابي" %}</span>
        </a>
    </nav>
    {% endblock bottom_nav %}

    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    {% block footer %}
    <footer class="main-footer">
        <div class="container py-5">
            <div class="row">
                <div class="col-md-3 mb-4">
                    <h3>{% trans "خدمة العملاء" %}</h3>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'store:shipping_policy' %}">{% trans "سياسة الشحن" %}</a></li>
                        <li><a href="{% url 'store:privacy_policy' %}">{% trans "سياسة الخصوصية" %}</a></li>
                        <li><a href="{% url 'store:contact' %}">{% trans "تواصل معنا" %}</a></li>
                    </ul>
                </div>
                <div class="col-md-3 mb-4">
                     <h3>{% trans "عن الشركة" %}</h3>
                     <ul class="list-unstyled">
                        <li><a href="{% url 'store:about' %}">{% trans "من نحن" %}</a></li>
                        <li><a href="#">{% trans "المدونة" %}</a></li>
                    </ul>
                </div>
                <div class="col-md-3 mb-4">
                    <h3>{% trans "تابعنا" %}</h3>
                    <div class="social-icons-footer">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <h3>{% trans "النشرة البريدية" %}</h3>
                    <p>{% trans "اشترك لتصلك آخر العروض." %}</p>
                    <form>
                        <div class="input-group">
                            <input type="email" class="form-control" placeholder="{% trans 'بريدك الإلكتروني' %}">
                            <button class="btn btn-primary" type="button">{% trans "اشتراك" %}</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="text-center mt-4">
                 <p class="copyright">&copy; {% now "Y" %} {% if site_config %}{{ site_config.site_name }}{% else %}متجري{% endif %}. {% trans "جميع الحقوق محفوظة." %}</p>
            </div>
        </div>
    </footer>
    {% endblock footer %}

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- Firebase SDK (v9 compat libraries) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAcxHbkWZTOm0hRQiwtB-tqQUoVvkEVUMM",
        authDomain: "nasser-8ed51.firebaseapp.com",
        projectId: "nasser-8ed51",
        storageBucket: "nasser-8ed51.firebasestorage.app",
        messagingSenderId: "452598851",
        appId: "1:452598798851:web:30124252bdf0569e6e8c36",
        measurementId: "G-P21WT74CNN"
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
    </script>

    {% block js %}{% endblock %}
    <script src="{% static 'js/main.js' %}"></script>

    <!-- Quick View Modal (Bootstrap) -->
    <div class="modal fade" id="quickViewModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="quickViewModalLabel">{% trans "نظرة سريعة" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="quickViewModalBody">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    {% if user.is_authenticated %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBell = document.getElementById('notificationBell');
            const notificationBadge = notificationBell.querySelector('.cart-badge');
            const notificationDropdown = document.querySelector('.notification-dropdown .notification-body');
            const noNotificationsMessage = notificationDropdown.querySelector('.text-center');

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;

            const notificationSocket = new WebSocket(wsUrl);

            notificationSocket.onopen = function(e) {
                console.log("Notification socket connected.");
            };

            notificationSocket.onmessage = function(e) {
                const data = JSON.parse(e.data).message;

                // 1. Update badge count
                let count = notificationBadge ? parseInt(notificationBadge.textContent) : 0;
                count++;
                if (notificationBadge) {
                    notificationBadge.textContent = count;
                } else {
                    const newBadge = document.createElement('span');
                    newBadge.className = 'badge bg-danger cart-badge';
                    newBadge.textContent = '1';
                    notificationBell.appendChild(newBadge);
                }

                // 2. Remove "no notifications" message if it exists
                if (noNotificationsMessage) {
                    noNotificationsMessage.remove();
                }

                // 3. Create and prepend new notification item
                const newNotification = document.createElement('a');
                newNotification.href = "#"; // Or use data.url if you add it
                newNotification.className = "dropdown-item notification-item notification-unread";
                newNotification.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="notification-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="notification-title mb-1">${data.title}</h6>
                            <p class="notification-message mb-1 small">${data.message}</p>
                            <small class="text-muted">${data.created_at}</small>
                        </div>
                    </div>`;
                
                notificationDropdown.prepend(newNotification);
            };

            notificationSocket.onclose = function(e) {
                console.error('Notification socket closed unexpectedly');
            };
        });
    </script>
    {% endif %}

</body>
</html> 